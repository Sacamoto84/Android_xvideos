package com.client.xvideos.redgifs.screens.profile

import android.annotation.SuppressLint
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.fillMaxHeight
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableIntStateOf
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.unit.dp
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import cafe.adriel.voyager.core.screen.Screen
import cafe.adriel.voyager.core.screen.ScreenKey
import cafe.adriel.voyager.core.screen.uniqueScreenKey
import cafe.adriel.voyager.hilt.getScreenModel
import cafe.adriel.voyager.navigator.LocalNavigator
import cafe.adriel.voyager.navigator.currentOrThrow
import com.client.xvideos.redgifs.ThemeRed
import com.client.xvideos.redgifs.common.block.BlockRed
import com.client.xvideos.redgifs.common.block.ui.DialogBlock
import com.client.xvideos.redgifs.common.ui.lazyrow123.LazyRow123
import com.client.xvideos.redgifs.screens.profile.atom.RedProfileCreaterInfo
import com.client.xvideos.redgifs.screens.profile.atom.VerticalScrollbar
import com.client.xvideos.redgifs.screens.profile.tags.TagsBlock
import com.composeunstyled.rememberDisclosureState

class ScreenRedProfile(val profileName: String) : Screen {

    override val key: ScreenKey = uniqueScreenKey

    @SuppressLint("UnusedMaterial3ScaffoldPaddingParameter", "UnusedBoxWithConstraintsScope")
    @Composable
    override fun Content() {
        val navigator = LocalNavigator.currentOrThrow

        //val vm: ScreenRedProfileSM = getScreenModel()

        val vm = getScreenModel<ScreenRedProfileSM, ScreenRedProfileSM.Factory> { factory ->
            factory.create(profileName)
        }

        //val gridState = rememberLazyGridState()
        val list = vm.list.collectAsState()

        val isLoading = vm.isLoading.collectAsState().value

        val stateDisclosure = rememberDisclosureState()
        var prevIndex by remember { mutableIntStateOf(0) }

        val selector = vm.selector.collectAsStateWithLifecycle().value

        var trackVisible by remember { mutableStateOf(false) }
        var visibleItems by remember { mutableIntStateOf(0) }

        //–†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–∫—Ä–æ–ª–ª
        val scrollPercent by rememberVisibleRangePercentIgnoringFirstNForGrid(
            gridState = vm.likedHost.state, itemsToIgnore = 3, numberOfColumns = 2
        )

         val block = vm.block

        //üü®üü®üü®üü®üü®üü®üü®üü®üé®üé®üé®üü®üü®üü®üü®üü®üü®üü®üü®
        //‚ï≠‚îà‚îà –î–∏–∞–ª–æ–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ‚îà‚îà‚ïÆ
        //‚îÇ –û—Ç–º–µ–Ω–∞    –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ‚îÇ
        //‚ï∞‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚ïØ
        DialogBlock(
            visible = block.blockVisibleDialog,
            onDismiss = { block.blockVisibleDialog = false }) {
            val a = vm.currentTikTokGifInfo; if (a != null) {
            block.blockItem(a)
            block.refreshListAndBlock(vm._list)
        }
        }
        //üü®üü®üü®üü®üü®üü®üü®üü®‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚ùó


        Scaffold( containerColor = ThemeRed.colorCommonBackground2 ) {
            Box(Modifier.padding(bottom = it.calculateBottomPadding())) {

//                //–¢–∏–∫—Ç–æ–∫ –ø—Ä–∏ –æ–¥–Ω–æ–º —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
//                if (selector == 1) {
//
//                    TikTokStyleVideoFeed(
//                        vm,
//                        list.value,
//                        onChangeTime = { it1 ->
//                            vm.currentPlayerTime = it1.first
//                            vm.currentPlayerDuration = it1.second
//                        },
//                        onPageUIElementsVisibilityChange = { it1 -> trackVisible = it1 },
//                        isMute = vm.mute,
//                        onLongClick = { },
//
//                        //–¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –ø–µ–π–¥–∂–µ—Ä–µ
//                        onChangePagerPage = { it1 -> vm.currentTikTokPage = it1 },
//                        modifier = Modifier,
//                        timeA = vm.timeA, timeB = vm.timeB, enableAB = vm.enableAB,
//
//                        menuContent = { MenuContent(vm) },
//                        menuContentWidth = 300.dp,
//
//                        menuDefaultOpen = vm.menuCenter,
//                        menuOpenChanged = { it1 ->
//                            vm.menuCenter = it1
//                            Timber.i("@@@ menuOpenChanged vm.menuCenter = it $it1")
//                        },
//                        initialPage = vm.tictikStartIndex
//                    )
//
//                } else {

                    Box(modifier = Modifier.fillMaxSize()) {


                        LazyRow123(
                            host = vm.likedHost,
                            modifier = Modifier.fillMaxSize(),
                            gotoPosition = vm.likedHost.currentIndexGoto,
                            contentPadding = PaddingValues(0.dp),
                            contentBeforeList = {

                                Column {

                                    if (vm.creator != null) {
                                        RedProfileCreaterInfo(vm.creator!!)
                                    }

                                    if ((vm.creator != null) && (vm.tags.collectAsStateWithLifecycle().value.isNotEmpty())) {
                                        TagsBlock(vm.tags.collectAsStateWithLifecycle().value.toList())
                                    }

                                }

                            },
                        )


//                        LaunchedEffect(vm.currentTikTokPage) {
//                            vm.likedHost.state.scrollToItem(vm.currentTikTokPage)
//                        }
//
//                        LazyVerticalGrid(
//                            state = vm.likedHost.state,
//                            columns = GridCells.Fixed(2),
//                            modifier = Modifier.fillMaxSize(),
//                            horizontalArrangement = Arrangement.spacedBy(4.dp),
//                            verticalArrangement = Arrangement.spacedBy(4.dp),
//                            contentPadding = PaddingValues(4.dp) // –û—Ç—Å—Ç—É–ø—ã –ø–æ –∫—Ä–∞—è–º —Å–µ—Ç–∫–∏
//                        ) {
//
//                            item(key = "info", span = { GridItemSpan(maxLineSpan) }) {
//                                if (vm.creator != null){
//                                    RedProfileCreaterInfo(vm.creator!!)
//                                }
//                            }
//
//                            item(key = "tags", span = { GridItemSpan(maxLineSpan) }) {
//                                if ((vm.creator != null) && (vm.tags.collectAsStateWithLifecycle().value.isNotEmpty())) {
//                                    TagsBlock(vm.tags.collectAsStateWithLifecycle().value.toList())
//                                }
//                            }
//
//
//
//                            //–¢–∞–π–ª—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ –≤–∏–¥–µ–æ
//                            itemsIndexed(
//                                count = vm.likedHost.li.itemCount,
//                                key = { index, item -> item.id }) { index, item ->
//                                Box(modifier = Modifier
//                                    .fillMaxSize()
//                                    .aspectRatio(1080f / 1920)) {
//                                    RedUrlVideoImageAndLongClick(item, index, onLongClick = {
//                                        vm.openFullScreen(index)
//                                    }, onDoubleClick = {}, onFullScreen = {
//                                        vm.openFullScreen(index)
//                                    }, isNetConnected = true //!!!
//                                    )
//                                }
//                            }
//                    }

                    //–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    if (isLoading) {
                        Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                            CircularProgressIndicator(
                                modifier = Modifier.size(56.dp),
                                strokeWidth = 8.dp
                            )
                        }
                    }

                    Text("      " + visibleItems.toString(), color = Color.White)

                    //---- –°–∫—Ä–æ–ª–ª ----
                    Box(
                        modifier = Modifier
                            .fillMaxHeight()
                            .align(Alignment.CenterEnd)
                            .width(2.dp)
                    ) { VerticalScrollbar(scrollPercent) }

                }


            }


        }
    }


//        // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –ø–æ–¥–≥—Ä—É–∑–∫—É, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞—ë—Ç—Å—è ‚â§6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–æ –∫–æ–Ω—Ü–∞
//        LaunchedEffect(gridState) {
//            withContext(Dispatchers.IO) {
//                snapshotFlow { gridState.layoutInfo }
//                    .distinctUntilChanged()
//                    .collect { info ->
//                        val last = info.visibleItemsInfo.lastOrNull()?.index ?: 0
//                        visibleItems = last - 3
//                        //Timber.d("!!! prevIndex = $prevIndex")
//                        //Timber.d("!!! last = $last")
//                        //Timber.d("!!! info.totalItemsCount = ${info.totalItemsCount}")
//
//                        // –¢—Ä–∏–≥–≥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–≤–∏–∂–µ–º—Å—è –í–ù–ò–ó
//                        if (last > prevIndex) {
//                            val total = info.totalItemsCount
//                            //if (total - last <= 6)
//                            //vm.loadNextPage()
//                        }
//                        prevIndex = last
//                    }
//            }
//        }


//        Scaffold(
//            //bottomBar = { RedBottomBar() },
//            containerColor = ThemeRed.colorCommonBackground
//        ) { padding ->
//
//            Box(modifier = Modifier.fillMaxSize()) {
//
//                LazyVerticalGrid(
//                    state = gridState,
//                    columns = if (vm.selector.collectAsStateWithLifecycle().value == 2) GridCells.Fixed(
//                        2
//                    ) else GridCells.Fixed(1),
//                    modifier = Modifier.fillMaxSize(),
//                    horizontalArrangement = Arrangement.spacedBy(4.dp),
//                    verticalArrangement = Arrangement.spacedBy(4.dp),
//                    contentPadding = PaddingValues(4.dp) // –û—Ç—Å—Ç—É–ø—ã –ø–æ –∫—Ä–∞—è–º —Å–µ—Ç–∫–∏
//                ) {
//
////                        item {
////                            Box(modifier = Modifier.aspectRatio(1f)) {
////                                RedUrlVideoLite("https://api.redgifs.com/v2/gifs/easytightibisbill/hd.m3u8")
////                            }
////
////                        }
//
//
//                    //–û–ø–∏—Å–∞–Ω–∏–µ –∏ —Ç–µ–≥–∏
//                    item(
//                        key = "info",
//                        span = { GridItemSpan(maxLineSpan) } // –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç —ç—Ç–æ—Ç item –∑–∞–Ω—è—Ç—å –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã
//                    ) {
//                        vm.creator?.let { profileData ->
//                            RedProfileCreaterInfo(profileData)
//                        }
//                    }
//
//                    //–¢–µ–≥–∏
//                    item(
//                        key = "tags",
//                        span = { GridItemSpan(maxLineSpan) } // –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç —ç—Ç–æ—Ç item –∑–∞–Ω—è—Ç—å –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã
//                    ) {
//                        vm.creator?.let { profileData ->
//                            Disclosure(state = stateDisclosure) {
//                                DisclosureHeading(
//                                    modifier = Modifier
//                                        .padding(horizontal = 2.dp)
//                                        .padding(top = 4.dp, bottom = 4.dp)
//                                        .fillMaxWidth()
//                                        .height(48.dp)
//                                        .clip(RoundedCornerShape(8.dp))
//                                        .background(if (stateDisclosure.expanded) ThemeRed.colorBorderGray else Color.Transparent)
//                                        .border(
//                                            1.dp,
//                                            ThemeRed.colorBorderGray,
//                                            RoundedCornerShape(8.dp)
//                                        ),
//                                    //shape = RoundedCornerShape(8.dp),
//                                    contentPadding = PaddingValues(
//                                        //vertical = 12.dp,
//                                        horizontal = 16.dp
//                                    ),
//                                    onClick = {
//                                        stateDisclosure.expanded =
//                                            stateDisclosure.expanded.not()
//                                    }) {
//
//                                    val degrees by animateFloatAsState(
//                                        if (stateDisclosure.expanded) -180f else 0f,
//                                        tween()
//                                    )
//
//                                    Row(
//                                        Modifier.fillMaxWidth(),
//                                        horizontalArrangement = Arrangement.SpaceBetween,
//                                        verticalAlignment = Alignment.CenterVertically
//                                    ) {
//                                        Text(
//                                            "Tags",
//                                            color = Color.White,
//                                            fontFamily = ThemeRed.fontFamilyPopinsRegular,
//                                            fontSize = 18.sp
//                                        )
//                                        Icon(
//                                            painter = painterResource(R.drawable.arrow_down),
//                                            contentDescription = null, tint = Color.White,
//                                            modifier = Modifier
//                                                .size(12.dp)
//                                                .rotate(degrees)
//                                        )
//                                    }
//                                }
//                                DisclosurePanel {
//                                    Box(
//                                        Modifier
//                                            .padding(top = 2.dp)
//                                            .padding(horizontal = 2.dp)
//                                            .fillMaxWidth()
//                                            .clip(RoundedCornerShape(8.dp))
//                                            .background(ThemeRed.colorBorderGray)
//                                            .padding(4.dp)
//                                    ) {
//                                        TagsBlock(vm.tags.collectAsStateWithLifecycle().value.toList())
//                                    }
//                                }
//                            }
//                        }
//                    }
//
//                    //–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º
//                    item(key = "keyboard", span = { GridItemSpan(maxLineSpan) }) {
//                        Box(
//                            Modifier
//                                .padding(horizontal = 2.dp)
//                                .padding(bottom = 2.dp)
//                                .fillMaxWidth()
//                        ) { RedProfileFeedControlsContainer(vm) }
//                    }
//
//
//                    //–¢–∞–π–ª—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ –≤–∏–¥–µ–æ
//                    itemsIndexed(list.value, key = { index, item -> item.id }) { index, item ->
//
//                        Box(
//                            modifier = Modifier
//                                .fillMaxSize()
//                                .aspectRatio(1080f / 1920)
//                        ) {
//                            //      RedUrlVideoLite("https://api.redgifs.com/v2/gifs/easytightibisbill/hd.m3u8")
//                            if ((visibleItems - 1) == index || (visibleItems - 2) == index || (visibleItems + 1) == index || (visibleItems) == index) {
//
//                                RedUrlVideoLite(
//                                    "https://api.redgifs.com/v2/gifs/${item.id.lowercase()}/hd.m3u8",
//                                    item.urls.thumbnail,
//                                    play = (visibleItems - 1) == index
//                                )
//                                //                                RedUrlVideoImageAndLongClick(
////                                    item,
////                                    index,
////                                    onLongClick = {},
////                                    onDoubleClick = {}
////                                )
//                            } else {
//                                RedProfileTile(item, index)
//                            }
//                        }
//
//                    }
//
//                }
//
//                //–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
//                if (isLoading) {
//                    Box(
//                        Modifier.fillMaxSize(),
//                        contentAlignment = Alignment.Center
//                    ) {
//                        CircularProgressIndicator(
//                            modifier = Modifier.size(56.dp),
//                            strokeWidth = 8.dp
//                        )
//                    }
//                }
//
//                Text("      " + visibleItems.toString(), color = Color.White)
//
//
//                //–°–∫—Ä–æ–ª–ª
//                Box(
//                    modifier = Modifier
//                        .fillMaxHeight()
//                        .align(Alignment.CenterEnd)
//                        .width(2.dp)
//                ) { VerticalScrollbar(scrollPercent) }
//
//            }
//        }

}

